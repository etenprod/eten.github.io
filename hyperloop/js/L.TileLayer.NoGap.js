L.TileLayer.mergeOptions({dumpToCanvas:L.Browser.canvas&&!L.Browser.ie}),L.TileLayer.include({_onUpdateLevel:function(a,t){this.options.dumpToCanvas&&(this._levels[a].canvas.style.zIndex=this.options.maxZoom-Math.abs(t-a))},_onRemoveLevel:function(a){this.options.dumpToCanvas&&L.DomUtil.remove(this._levels[a].canvas)},_onCreateLevel:function(a){this.options.dumpToCanvas&&(a.canvas=L.DomUtil.create("canvas","leaflet-tile-container leaflet-zoom-animated",this._container),a.ctx=a.canvas.getContext("2d"),this._resetCanvasSize(a))},_removeTile:function(a){if(this.options.dumpToCanvas){var t=this._tiles[a],e=this._levels[t.coords.z],s=this.getTileSize();if(e){var i=L.point(t.coords.x,t.coords.y).subtract(e.canvasRange.min).scaleBy(this.getTileSize());e.ctx.clearRect(i.x,i.y,s.x,s.y)}}L.GridLayer.prototype._removeTile.call(this,a)},_resetCanvasSize:function(a){var t=this.options.keepBuffer,e=this._getTiledPixelBounds(this._map.getCenter()),s=this._pxBoundsToTileRange(e),i=this.getTileSize();s.min=s.min.subtract([t,t]),s.max=s.max.add([t+1,t+1]);var n=L.bounds(s.min.scaleBy(i),s.max.add([1,1]).scaleBy(i)),o=!1,r=n.max.subtract(n.min);if(r.x>a.canvas.width||r.y>a.canvas.height){var c={x:a.canvas.width,y:a.canvas.height},v=L.DomUtil.create("canvas");v.style.width=(v.width=c.x)+"px",v.style.height=(v.height=c.y)+"px",v.getContext("2d").drawImage(a.canvas,0,0),a.canvas.style.width=(a.canvas.width=r.x)+"px",a.canvas.style.height=(a.canvas.height=r.y)+"px",a.ctx.drawImage(v,0,0)}if(a.canvasRange){var h=a.canvasRange.min.subtract(s.min).scaleBy(this.getTileSize());if(L.Browser.safari){if(!this._tmpCanvas){var l=this._tmpCanvas=L.DomUtil.create("canvas");l.width=a.canvas.width,l.height=a.canvas.height,this._tmpContext=l.getContext("2d")}this._tmpContext.clearRect(0,0,a.canvas.width,a.canvas.height),this._tmpContext.drawImage(a.canvas,0,0),a.ctx.clearRect(0,0,a.canvas.width,a.canvas.height),a.ctx.drawImage(this._tmpCanvas,h.x,h.y)}else a.ctx.globalCompositeOperation="copy",a.ctx.drawImage(a.canvas,h.x,h.y),a.ctx.globalCompositeOperation="source-over";o=!0}a.canvasRange=s,a.canvasPxRange=n,a.canvasOrigin=n.min,o&&this._setCanvasZoomTransform(a,this._map.getCenter(),this._map.getZoom())},_setZoomTransform:function(a,t,e){L.GridLayer.prototype._setZoomTransform.call(this,a,t,e),this.options.dumpToCanvas&&this._setCanvasZoomTransform(a,t,e)},_setCanvasZoomTransform:function(a,t,e){if(a.canvasOrigin){var s=this._map.getZoomScale(e,a.zoom),i=a.canvasOrigin.multiplyBy(s).subtract(this._map._getNewPixelOrigin(t,e)).round();L.Browser.any3d?L.DomUtil.setTransform(a.canvas,i,s):L.DomUtil.setPosition(a.canvas,i)}},_onOpaqueTile:function(a){if(this.options.dumpToCanvas){try{this.dumpPixels(a.coords,a.el)}catch(t){return this.fire("tileerror",{error:"Could not copy tile pixels: "+t,tile:a,coods:a.coords})}a.el.style.display="none"}},dumpPixels:function(a,t){var e=this._levels[a.z],s=this.getTileSize();if(e.canvasRange&&this.options.dumpToCanvas){e.canvasRange.contains(a)||this._resetCanvasSize(e);var i=L.point(a.x,a.y).subtract(e.canvasRange.min).scaleBy(this.getTileSize());return e.ctx.drawImage(t,i.x,i.y,s.x,s.y),this}}});